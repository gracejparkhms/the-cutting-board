<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Cutting Board</title>
<link rel="icon" type="image/png" href="favicon.png">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --white: #ffffff;
    --off-white: #f8f8f8;
    --light: #eeeeee;
    --mid: #cccccc;
    --dim: #888888;
    --dark: #444444;
    --black: #111111;
    --link: #0000cc;
    --link-hover: #0000ff;
    --border: #dddddd;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: Arial, sans-serif;
    background: var(--off-white);
    color: var(--black);
    min-height: 100vh;
    font-size: 13px;
  }

  #app { display: flex; height: 100vh; overflow: hidden; }

  /* SIDEBAR */
  #sidebar {
    width: 300px;
    min-width: 300px;
    background: var(--white);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  #sidebar-header {
    padding: 24px 20px 16px;
    border-bottom: 1px solid var(--border);
  }

  #sidebar-header h1 {
    font-size: 14px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--black);
  }

  #sidebar-header p {
    font-size: 11px;
    color: var(--dim);
    margin-top: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  #search-filter {
    padding: 14px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  #search-filter input,
  #search-filter select {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid var(--border);
    font-family: Arial, sans-serif;
    font-size: 12px;
    background: var(--off-white);
    color: var(--black);
    outline: none;
  }

  #search-filter input:focus,
  #search-filter select:focus { border-color: var(--dark); }

  #filter-row { display: flex; gap: 8px; }
  #filter-row select { flex: 1; }
  #filter-row .filter-col { display: flex; flex-direction: column; gap: 3px; flex: 1; }
  .filter-label { font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.8px; color: var(--dim); }

  #recipe-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
  }

  .recipe-card {
    padding: 12px 20px;
    cursor: pointer;
    border-bottom: 1px solid var(--light);
    transition: background 0.1s;
  }

  .recipe-card:hover { background: var(--off-white); }
  .recipe-card.active { background: var(--light); }

  .recipe-card-title {
    font-size: 12px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--black);
    line-height: 1.4;
  }

  .recipe-card-meta {
    font-size: 11px;
    color: var(--dim);
    margin-top: 4px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .empty-state {
    text-align: center;
    padding: 48px 20px;
    color: var(--dim);
  }

  .empty-state p {
    font-size: 12px;
    line-height: 1.7;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* MAIN */
  #main {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  /* ADD PANEL */
  #add-panel {
    background: var(--white);
    border-bottom: 1px solid var(--border);
    padding: 18px 32px;
  }

  #add-panel h2 {
    font-size: 11px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--dim);
    margin-bottom: 10px;
  }

  #url-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

  #url-input {
    flex: 1;
    min-width: 200px;
    padding: 9px 12px;
    border: 1px solid var(--border);
    font-family: Arial, sans-serif;
    font-size: 12px;
    background: var(--off-white);
    color: var(--black);
    outline: none;
  }

  #url-input:focus { border-color: var(--dark); }

  .btn {
    padding: 9px 16px;
    border: 1px solid var(--border);
    font-family: Arial, sans-serif;
    font-size: 11px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    cursor: pointer;
    transition: background 0.1s;
    white-space: nowrap;
    background: var(--off-white);
    color: var(--black);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
  }

  .btn:hover { background: var(--light); }
  .btn-primary { background: var(--black); color: var(--white); border-color: var(--black); }
  .btn-primary:hover { background: var(--dark); border-color: var(--dark); }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-danger { color: var(--dim); }
  .btn-danger:hover { background: var(--light); color: var(--black); }

  #api-key-toggle {
    font-size: 11px;
    color: var(--link);
    cursor: pointer;
    text-decoration: underline;
    margin-top: 8px;
    display: inline-block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  #api-key-toggle:hover { color: var(--link-hover); }

  #api-key-row {
    display: none;
    margin-top: 8px;
    gap: 10px;
    align-items: center;
  }

  #api-key-row input {
    flex: 1;
    padding: 8px 10px;
    border: 1px solid var(--border);
    font-family: Arial, sans-serif;
    font-size: 12px;
    background: var(--off-white);
    color: var(--black);
    outline: none;
  }

  #api-key-row span {
    font-size: 11px;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  #status-msg {
    margin-top: 8px;
    font-size: 12px;
    padding: 7px 10px;
    display: none;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    border-left: 3px solid var(--mid);
  }

  #status-msg.loading { background: var(--off-white); color: var(--dark); display: block; }
  #status-msg.error { background: var(--off-white); color: var(--black); display: block; border-left-color: var(--black); }
  #status-msg.success { background: var(--off-white); color: var(--dark); display: block; }

  /* RECIPE VIEW */
  #recipe-view {
    flex: 1;
    padding: 40px 52px;
    max-width: 1100px;
  }

  .rv-layout {
    display: grid;
    grid-template-columns: 1fr 220px;
    gap: 40px;
    align-items: start;
  }

  .rv-main {
    min-width: 0;
  }

  /* Notes panel */
  .notes-panel {
    border: 1px solid var(--border);
    background: var(--white);
    padding: 14px;
  }

  .notes-panel-label {
    font-size: 10px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--dim);
    margin-bottom: 8px;
  }

  .notes-textarea {
    width: 100%;
    min-height: 80px;
    padding: 8px;
    border: 1px solid var(--border);
    font-family: Arial, sans-serif;
    font-size: 12px;
    line-height: 1.6;
    color: var(--black);
    background: var(--off-white);
    outline: none;
    resize: vertical;
  }

  .notes-textarea:focus { border-color: var(--dark); }

  /* Notes log */
  .notes-add-row {
    display: flex;
    gap: 6px;
    margin-bottom: 10px;
  }

  .notes-add-row textarea {
    flex: 1;
    padding: 7px 8px;
    border: 1px solid var(--border);
    font-family: Arial, sans-serif;
    font-size: 11px;
    line-height: 1.5;
    color: var(--black);
    background: var(--off-white);
    outline: none;
    resize: none;
    min-height: 56px;
  }

  .notes-add-row textarea:focus { border-color: var(--dark); }

  .notes-add-btn {
    padding: 6px 10px;
    font-size: 10px;
    font-family: Arial, sans-serif;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    background: var(--black);
    color: var(--white);
    border: 1px solid var(--black);
    cursor: pointer;
    align-self: flex-start;
    white-space: nowrap;
  }

  .notes-add-btn:hover { background: var(--dark); }

  .notes-log {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .note-entry {
    border: 1px solid var(--border);
    background: var(--off-white);
    padding: 8px 10px;
    position: relative;
  }

  .note-entry-date {
    font-size: 9px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--dim);
    margin-bottom: 4px;
  }

  .note-entry-text {
    font-size: 11px;
    line-height: 1.5;
    color: var(--black);
    white-space: pre-wrap;
  }

  .note-entry-delete {
    position: absolute;
    top: 6px;
    right: 6px;
    background: none;
    border: none;
    font-size: 10px;
    color: var(--mid);
    cursor: pointer;
    font-family: Arial, sans-serif;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 0;
    line-height: 1;
  }

  .note-entry-delete:hover { color: var(--black); }

  .notes-saved {
    font-size: 10px;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 6px;
    min-height: 14px;
  }

  /* Photo panel */
  .photos-panel {
    border: 1px solid var(--border);
    background: var(--white);
    padding: 14px;
    margin-top: 10px;
  }

  .photos-panel-label {
    font-size: 10px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--dim);
    margin-bottom: 8px;
  }

  .photo-slots {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .photo-slot {
    position: relative;
    width: 100%;
    aspect-ratio: 4/3;
    border: 1px solid var(--border);
    background: var(--off-white);
    overflow: hidden;
    cursor: pointer;
  }

  .photo-slot img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .photo-slot-empty {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--mid);
    flex-direction: column;
    gap: 5px;
  }

  .photo-slot-empty-icon {
    font-size: 18px;
    color: var(--mid);
  }

  .photo-slot:hover .photo-slot-empty {
    background: var(--light);
    color: var(--dark);
  }

  .photo-remove {
    position: absolute;
    top: 4px;
    right: 4px;
    background: rgba(0,0,0,0.55);
    color: white;
    border: none;
    font-size: 11px;
    font-family: Arial, sans-serif;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 3px 7px;
    cursor: pointer;
    display: none;
  }

  .photo-slot:hover .photo-remove { display: block; }

  #welcome-screen {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    padding: 60px;
    text-align: center;
    color: var(--dim);
  }

  #welcome-screen h2 {
    font-size: 13px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--dark);
    margin-bottom: 10px;
  }

  #welcome-screen p {
    font-size: 12px;
    line-height: 1.8;
    max-width: 340px;
    text-transform: uppercase;
    letter-spacing: 0.4px;
  }

  .rv-title {
    font-size: 22px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--black);
    margin-bottom: 6px;
    line-height: 1.25;
  }

  .rv-source {
    font-size: 11px;
    color: var(--dim);
    margin-bottom: 20px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .rv-source a { color: var(--link); text-decoration: underline; }
  .rv-source a:hover { color: var(--link-hover); }

  .rv-meta {
    display: inline-flex;
    flex-wrap: wrap;
    margin-bottom: 28px;
    border: 1px solid var(--border);
  }

  .rv-meta-item {
    text-align: center;
    padding: 14px 24px;
    border-right: 1px solid var(--border);
  }

  .rv-meta-item:last-child { border-right: none; }

  .rv-meta-item .label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--dim);
  }

  .rv-meta-item .value {
    font-size: 20px;
    font-weight: bold;
    color: var(--black);
    line-height: 1.2;
    margin-top: 3px;
  }

  .rv-meta-item .unit {
    font-size: 10px;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .rv-divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 28px 0;
  }

  .rv-section-title {
    font-size: 11px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--dim);
    margin-bottom: 14px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }

  /* Ingredients */
  .ingredients-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
    gap: 4px;
    margin-bottom: 8px;
  }

  .ingredient-group {
    margin-bottom: 18px;
  }

  .ingredient-group-label {
    font-size: 10px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--dim);
    margin-bottom: 6px;
  }

  .ingredient-item {
    padding: 8px 10px;
    background: var(--white);
    border: 1px solid var(--border);
    font-size: 12px;
    display: flex;
    align-items: baseline;
    gap: 6px;
    cursor: pointer;
    transition: background 0.1s;
  }

  .ingredient-item:hover { background: var(--off-white); }

  .ingredient-item.checked {
    text-decoration: line-through;
    color: var(--mid);
    background: var(--off-white);
  }

  .ingredient-item .qty {
    font-weight: bold;
    color: var(--dark);
    font-size: 12px;
    min-width: fit-content;
  }

  /* Steps */
  .step-item {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
    align-items: flex-start;
  }

  .step-num {
    min-width: 24px;
    height: 24px;
    background: var(--black);
    color: var(--white);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
    flex-shrink: 0;
    margin-top: 1px;
  }

  .step-text {
    font-size: 13px;
    line-height: 1.75;
    color: var(--black);
    padding-top: 3px;
  }

  /* Comments */
  .comment-item {
    padding: 10px 14px;
    background: var(--white);
    border: 1px solid var(--border);
    border-left: 3px solid var(--mid);
    margin-bottom: 8px;
    font-size: 12px;
    line-height: 1.7;
    color: var(--dark);
  }

  .comment-item.worked { border-left-color: var(--dark); }
  .comment-item.didnt { border-left-color: var(--black); }
  .comment-item.tip { border-left-color: var(--mid); }

  .comment-item .comment-type {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: bold;
    color: var(--dim);
    margin-bottom: 4px;
  }

  .rv-actions {
    display: flex;
    gap: 8px;
    margin-bottom: 22px;
  }

  /* Tags */
  .rv-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-bottom: 18px;
  }

  .tag {
    padding: 3px 8px;
    background: var(--off-white);
    border: 1px solid var(--border);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--dark);
  }

  /* Login screen */
  #login-screen {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
    color: var(--dim);
  }

  #login-screen h2 {
    font-size: 13px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--black);
  }

  #login-screen p {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--dim);
  }

  .btn-github {
    background: var(--black);
    color: var(--white);
    border-color: var(--black);
    padding: 11px 24px;
    font-size: 12px;
    letter-spacing: 1px;
  }

  .btn-github:hover { background: var(--dark); border-color: var(--dark); }

  #user-bar {
    display: none;
    font-size: 11px;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 8px;
    align-items: center;
    gap: 10px;
  }

  #user-bar a {
    color: var(--link);
    cursor: pointer;
    text-decoration: underline;
  }

  /* Heat sliders */
  .heat-sliders {
    display: flex;
    gap: 24px;
    margin-bottom: 28px;
    flex-wrap: wrap;
  }

  .heat-slider-block {
    flex: 1;
    min-width: 160px;
  }

  .heat-slider-title {
    font-size: 10px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--dim);
    margin-bottom: 10px;
  }

  .heat-slider-wrap {
    position: relative;
    padding-bottom: 18px;
  }

  .heat-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 2px;
    border-radius: 0;
    outline: none;
    cursor: pointer;
    background: linear-gradient(to right, var(--black) 0%, var(--black) 0%, var(--light) 0%);
  }

  .heat-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 14px;
    height: 14px;
    background: var(--black);
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid var(--white);
    box-shadow: 0 0 0 1px var(--black);
  }

  .heat-slider::-moz-range-thumb {
    width: 14px;
    height: 14px;
    background: var(--black);
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid var(--white);
    box-shadow: 0 0 0 1px var(--black);
  }

  .heat-slider-labels {
    position: relative;
    height: 14px;
    margin-top: 6px;
  }

  .heat-slider-labels span {
    position: absolute;
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--dim);
    transform: translateX(-50%);
    white-space: nowrap;
  }

  .heat-slider-labels span:nth-child(1) { left: 0%; transform: translateX(0); }
  .heat-slider-labels span:nth-child(2) { left: 25%; transform: translateX(-50%); }
  .heat-slider-labels span:nth-child(3) { left: 50%; transform: translateX(-50%); }
  .heat-slider-labels span:nth-child(4) { left: 75%; transform: translateX(-50%); }
  .heat-slider-labels span:nth-child(5) { left: 100%; transform: translateX(-100%); }

  /* Import mode toggle */
  .import-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 10px;
    border-bottom: 1px solid var(--border);
  }

  .import-tab {
    font-size: 11px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    padding: 6px 14px;
    cursor: pointer;
    color: var(--dim);
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
    font-family: Arial, sans-serif;
  }

  .import-tab.active {
    color: var(--black);
    border-bottom-color: var(--black);
  }

  .import-tab:hover { color: var(--dark); }

  #paste-row {
    display: none;
    flex-direction: column;
    gap: 8px;
  }

  #paste-row textarea {
    width: 100%;
    height: 100px;
    padding: 9px 12px;
    border: 1px solid var(--border);
    font-family: Arial, sans-serif;
    font-size: 12px;
    background: var(--off-white);
    color: var(--black);
    outline: none;
    resize: vertical;
  }

  #paste-row textarea:focus { border-color: var(--dark); }

  #paste-row-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }

  #paste-source-input {
    flex: 1;
    min-width: 150px;
    padding: 9px 12px;
    border: 1px solid var(--border);
    font-family: Arial, sans-serif;
    font-size: 12px;
    background: var(--off-white);
    color: var(--black);
    outline: none;
  }

  #paste-source-input:focus { border-color: var(--dark); }

  /* Edit mode */
  .edit-field {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid var(--border);
    font-family: Arial, sans-serif;
    font-size: 13px;
    background: var(--off-white);
    color: var(--black);
    outline: none;
    resize: vertical;
  }

  .edit-field:focus { border-color: var(--dark); }

  .edit-title {
    font-size: 20px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
    width: 100%;
    padding: 8px 10px;
    border: 1px solid var(--border);
    font-family: Arial, sans-serif;
    background: var(--off-white);
    color: var(--black);
    outline: none;
    margin-bottom: 10px;
  }

  .edit-title:focus { border-color: var(--dark); }

  .edit-meta-row {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .edit-meta-item {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  .edit-meta-item input {
    width: 90px;
    padding: 8px 10px;
    border: 1px solid var(--border);
    font-family: Arial, sans-serif;
    font-size: 13px;
    background: var(--off-white);
    color: var(--black);
    outline: none;
  }

  .edit-meta-item input:focus { border-color: var(--dark); }

  .edit-section {
    margin-bottom: 24px;
  }

  .edit-hint {
    font-size: 11px;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 0.4px;
    margin-bottom: 6px;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--light); }

  /* Spinner */
  .spinner {
    display: inline-block;
    width: 10px;
    height: 10px;
    border: 2px solid var(--light);
    border-top-color: var(--dark);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    vertical-align: middle;
    margin-right: 6px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* Modal */
  #modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }

  .modal-box {
    background: var(--white);
    padding: 32px;
    width: 90%;
    max-width: 540px;
    max-height: 85vh;
    overflow-y: auto;
    border: 1px solid var(--border);
  }

  .modal-box h2 {
    font-size: 12px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 20px;
    color: var(--black);
  }

  .modal-field-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .field-label {
    font-size: 10px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--dim);
    margin-bottom: 4px;
  }

  .modal-box input,
  .modal-box textarea {
    width: 100%;
    padding: 9px 10px;
    border: 1px solid var(--border);
    font-family: Arial, sans-serif;
    font-size: 12px;
    background: var(--off-white);
    color: var(--black);
    outline: none;
    resize: vertical;
  }

  .modal-box input:focus,
  .modal-box textarea:focus { border-color: var(--dark); }

  .modal-row { display: flex; gap: 8px; }
  .modal-row > div { flex: 1; }

  .modal-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 4px;
  }
</style>
</head>
<body>
<div id="app">

  <!-- SIDEBAR -->
  <div id="sidebar">
    <div id="sidebar-header">
      <h1>The Cutting Board</h1>
      <p id="recipe-count-label">0 recipes saved</p>
    </div>

    <div id="search-filter">
      <input type="text" id="search-input" placeholder="keyword search" oninput="filterRecipes()">
      <div id="filter-row">
        <div class="filter-col">
          <span class="filter-label">time</span>
          <select id="filter-time" onchange="filterRecipes()">
            <option value="">nowhere to be</option>
            <option value="30">under 30 min</option>
            <option value="60">under 1 hour</option>
            <option value="120">under 2 hours</option>
          </select>
        </div>
        <div class="filter-col">
          <span class="filter-label">sort by</span>
          <select id="sort-by" onchange="filterRecipes()">
            <option value="recent">recently added</option>
            <option value="geography">geography</option>
            <option value="heat_spice">heat (spice)</option>
            <option value="heat_temp">heat (temperature)</option>
          </select>
        </div>
      </div>
    </div>

    <div id="recipe-list">
      <div class="empty-state">
        <p>Library empty</p>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div id="main">
    <div id="add-panel">
      <h2>Add a Recipe</h2>
      <div class="import-tabs">
        <button class="import-tab active" id="tab-url" onclick="switchImportTab('url')">URL</button>
        <button class="import-tab" id="tab-paste" onclick="switchImportTab('paste')">Paste Text</button>
        <button class="import-tab" id="tab-manual" onclick="openManualEntry()">Manual</button>
      </div>
      <div id="url-row">
        <input type="url" id="url-input" placeholder="Paste a recipe URL">
        <button class="btn btn-primary" id="scrape-btn" onclick="scrapeRecipe()">Import</button>
      </div>
      <div id="paste-row">
        <textarea id="paste-text" placeholder="Paste the full recipe text here - ingredients, steps, comments, everything you can select from the page..."></textarea>
        <div id="paste-row-actions">
          <input id="paste-source-input" type="url" placeholder="Source URL (optional)">
          <button class="btn btn-primary" id="paste-btn" onclick="pasteRecipe()">Import</button>
        </div>
      </div>
      <span id="api-key-toggle" onclick="toggleApiKey()">Set API key</span>
      <div id="api-key-row">
        <input type="password" id="api-key-input" placeholder="sk-ant-..." oninput="saveApiKey()">
        <span>Saved locally in your browser</span>
      </div>
      <div id="status-msg"></div>
      <div id="user-bar">
        <span id="user-label"></span>
        <a onclick="signOut()">Sign out</a>
      </div>
    </div>

    <div id="login-screen" style="display:none">
      <h2>The Cutting Board</h2>
      <p>Sign in to access your recipe library</p>
      <button class="btn btn-github" onclick="signInWithGitHub()">Sign in with GitHub</button>
    </div>

    <div id="welcome-screen">
      <p>Add a recipe above</p>
    </div>

    <div id="recipe-view" style="display:none"></div>
  </div>
</div>

<!-- MANUAL ENTRY MODAL -->
<div id="modal-overlay">
  <div class="modal-box">
    <h2>Add Recipe Manually</h2>
    <div class="modal-field-group">
      <div>
        <div class="field-label">Title *</div>
        <input id="m-title" placeholder="Recipe title">
      </div>
      <div>
        <div class="field-label">Source URL</div>
        <input id="m-source" placeholder="https://...">
      </div>
      <div class="modal-row">
        <div>
          <div class="field-label">Active time (min)</div>
          <input id="m-active" type="number" placeholder="20">
        </div>
        <div>
          <div class="field-label">Passive time (min)</div>
          <input id="m-passive" type="number" placeholder="45">
        </div>
        <div>
          <div class="field-label">Servings</div>
          <input id="m-servings" type="number" placeholder="4">
        </div>
      </div>
      <div>
        <div class="field-label">Tags (comma-separated)</div>
        <input id="m-tags" placeholder="pasta, vegetarian">
      </div>
      <div>
        <div class="field-label">Ingredients (one per line)</div>
        <textarea id="m-ingredients" rows="6" placeholder="2 cups flour&#10;1 tsp salt"></textarea>
      </div>
      <div>
        <div class="field-label">Steps (one per line)</div>
        <textarea id="m-steps" rows="6" placeholder="Preheat oven to 350F.&#10;Mix dry ingredients."></textarea>
      </div>
      <div>
        <div class="field-label">Notes from Others (prefix: PROCESS: / FLAVOR: / SUBSTITUTION:)</div>
        <textarea id="m-comments" rows="4" placeholder="PROCESS: use store bought stock&#10;FLAVOR: add smoked paprika"></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveManualRecipe()">Save Recipe</button>
      </div>
    </div>
  </div>
</div>

<script>
// -- SUPABASE --
const SUPABASE_URL = 'https://ozwlelxsqfpfadtfiipm.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96d2xlbHhzcWZwZmFkdGZpaXBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjgxMzUsImV4cCI6MjA4NzU0NDEzNX0.kodb6Pb8cHFjfnUqAI654bSRXid7hGy4mYo77a1k_bc';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let recipes = [];
let activeId = null;
let currentUserId = null;

function signInWithGitHub() {
  sb.auth.signInWithOAuth({
    provider: 'github',
    options: { redirectTo: 'https://gracejparkhms.github.io/the-cutting-board/' }
  });
}

async function signOut() {
  await sb.auth.signOut();
  currentUserId = null;
  recipes = [];
  renderList();
  document.getElementById('add-panel').style.display = 'none';
  document.getElementById('welcome-screen').style.display = 'none';
  document.getElementById('recipe-view').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('user-bar').style.display = 'none';
}

async function initAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    currentUserId = session.user.id;
    showAppForUser(session.user);
  } else {
    showLoginScreen();
  }

  // Listen for auth changes (e.g. after OAuth redirect)
  sb.auth.onAuthStateChange((_event, session) => {
    if (session && !currentUserId) {
      currentUserId = session.user.id;
      showAppForUser(session.user);
      load().then(() => {
        renderList();
        if (recipes.length > 0) showRecipe(recipes[0].id);
      });
    }
  });
}

function showLoginScreen() {
  document.getElementById('add-panel').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('welcome-screen').style.display = 'none';
}

function showAppForUser(user) {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('add-panel').style.display = 'block';
  document.getElementById('welcome-screen').style.display = 'flex';
  const userBar = document.getElementById('user-bar');
  userBar.style.display = 'flex';
  const label = document.getElementById('user-label');
  if (label) label.textContent = user.user_metadata?.user_name || user.email || 'Signed in';
}

async function save(recipe) {
  if (!currentUserId) return;
  const { error } = await sb
    .from('recipes')
    .upsert({ id: recipe.id, user_id: currentUserId, data: recipe }, { onConflict: 'id' });
  if (error) console.error('Save error:', error);
}

async function saveAll() {
  // Used after bulk operations - upsert all recipes
  if (!currentUserId) return;
  const rows = recipes.map(r => ({ id: r.id, user_id: currentUserId, data: r }));
  const { error } = await sb.from('recipes').upsert(rows, { onConflict: 'id' });
  if (error) console.error('SaveAll error:', error);
}

async function deleteFromDb(id) {
  if (!currentUserId) return;
  const { error } = await sb.from('recipes').delete().eq('id', id).eq('user_id', currentUserId);
  if (error) console.error('Delete error:', error);
}

async function load() {
  if (!currentUserId) return;
  const { data, error } = await sb
    .from('recipes')
    .select('data')
    .eq('user_id', currentUserId)
    .order('created_at', { ascending: false });
  if (error) { console.error('Load error:', error); return; }
  recipes = (data || []).map(row => row.data);
  const key = localStorage.getItem('rl-api-key');
  if (key) document.getElementById('api-key-input').value = key;
}

function saveApiKey() {
  localStorage.setItem('rl-api-key', document.getElementById('api-key-input').value.trim());
}

function getApiKey() {
  return localStorage.getItem('rl-api-key') || '';
}

// Init
initAuth().then(() => {
  if (currentUserId) {
    load().then(() => {
      renderList();
      if (recipes.length > 0) showRecipe(recipes[0].id);
    });
  }
});

function toggleApiKey() {
  const row = document.getElementById('api-key-row');
  row.style.display = row.style.display === 'flex' ? 'none' : 'flex';
}

function switchImportTab(mode) {
  document.getElementById('url-row').style.display = mode === 'url' ? 'flex' : 'none';
  document.getElementById('paste-row').style.display = mode === 'paste' ? 'flex' : 'none';
  document.getElementById('tab-url').classList.toggle('active', mode === 'url');
  document.getElementById('tab-paste').classList.toggle('active', mode === 'paste');
  clearStatus();
}

async function parseRecipeFromText(pageText, sourceUrl, sourceName) {
  const apiKey = getApiKey();
  if (!apiKey) {
    setStatus('Please set your Anthropic API key first.', 'error');
    toggleApiKey();
    return null;
  }

  const prompt = `You are a recipe extraction assistant. Your job is to faithfully extract a recipe exactly as written by the author, then separately capture any modifications suggested in the comments.

URL: ${sourceUrl || 'unknown'}
Page content:
${pageText.substring(0, 12000)}

Return a JSON object with EXACTLY this structure (no markdown, just raw JSON):
{
  "title": "Recipe name",
  "source_url": "${sourceUrl || ''}",
  "source_name": "${sourceName || ''}",
  "active_time_minutes": 20,
  "passive_time_minutes": 45,
  "servings": 4,
  "tags": ["tag1", "tag2"],
  "ingredient_groups": [
    {
      "section": "Produce",
      "items": [{"qty": "2 cloves", "item": "garlic"}, {"qty": "1", "item": "onion"}]
    },
    {
      "section": "Pantry",
      "items": [{"qty": "2 cups", "item": "all-purpose flour"}]
    },
    {
      "section": "Spices & Seasonings",
      "items": [{"qty": "1 tsp", "item": "salt"}]
    }
  ],
  "steps": [
    "Step one, copied verbatim or near-verbatim from the recipe.",
    "Step two."
  ],
  "comment_highlights": [
    {"type": "worked", "text": "An easier process or shortcut commenters found"},
    {"type": "didnt", "text": "Something to watch out for or a common mistake commenters flagged"},
    {"type": "tip", "text": "A different flavor profile or substitution commenters suggested"}
  ]
}

CRITICAL RULES:
1. Ingredients: Copy the official ingredient list EXACTLY as written by the recipe author. Do not add, remove, or alter any ingredient.
2. Steps: Copy the official instructions faithfully. Do not incorporate comment suggestions into the steps.
3. comment_highlights: ONLY put content here from the comments/reviews section. Extract 2-6 useful insights.
4. Ingredient groups: Group all official ingredients into logical sections. Good section names: Produce, Meat & Seafood, Dairy, Pantry, Spices & Seasonings, Canned & Jarred, Bread & Baked Goods, Frozen, Other.
5. Tags: cuisine type, main ingredient, dietary info, meal type.
6. active_time_minutes: hands-on time. passive_time_minutes: waiting time.
Return only valid JSON.`;

  const res = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      "Content-Type": "application/json",
      "x-api-key": apiKey,
      "anthropic-version": "2023-06-01",
      "anthropic-dangerous-direct-browser-access": "true"
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-6',
      max_tokens: 2000,
      messages: [{ role: 'user', content: prompt }]
    })
  });

  if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error?.message || 'API error');
  }

  const data = await res.json();
  let text = data.content[0].text.trim();
  // Strip markdown fences
  text = text.replace(/^```json\s*/i, '').replace(/^```\s*/i, '').replace(/\s*```$/, '').trim();
  // Extract JSON object if there's surrounding text
  const jsonMatch = text.match(/\{[\s\S]*\}/);
  if (jsonMatch) text = jsonMatch[0];
  return JSON.parse(text);
}

async function pasteRecipe() {
  const pageText = document.getElementById('paste-text').value.trim();
  if (!pageText) { setStatus('Please paste some recipe text first.', 'error'); return; }

  const sourceUrl = document.getElementById('paste-source-input').value.trim();
  const sourceName = sourceUrl ? new URL(sourceUrl.startsWith('http') ? sourceUrl : 'https://' + sourceUrl).hostname.replace('www.', '') : '';

  document.getElementById('paste-btn').disabled = true;
  setStatus('Parsing the recipe...', 'loading');

  try {
    const recipe = await parseRecipeFromText(pageText, sourceUrl, sourceName);
    if (!recipe) return;
    recipe.id = Date.now().toString();
    recipe.added_at = new Date().toISOString();
    recipes.unshift(recipe);
    await save(recipe);
    renderList();
    showRecipe(recipe.id);
    document.getElementById('paste-text').value = '';
    document.getElementById('paste-source-input').value = '';
    setStatus(`Saved: ${recipe.title}`, 'success');
    setTimeout(clearStatus, 4000);
  } catch(e) {
    setStatus(`Error: ${e.message}`, 'error');
  } finally {
    document.getElementById('paste-btn').disabled = false;
  }
}

function setStatus(msg, type) {
  const el = document.getElementById('status-msg');
  el.className = type;
  el.innerHTML = type === 'loading' ? `<span class="spinner"></span>${msg}` : msg;
}

function clearStatus() {
  const el = document.getElementById('status-msg');
  el.className = '';
  el.style.display = 'none';
}

async function scrapeRecipe() {
  const url = document.getElementById('url-input').value.trim();
  if (!url) { setStatus('Please enter a recipe URL.', 'error'); return; }

  document.getElementById('scrape-btn').disabled = true;
  setStatus('Fetching and parsing the recipe...', 'loading');

  try {
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
    let pageText = '';

    try {
      const proxyRes = await fetch(proxyUrl);
      const proxyData = await proxyRes.json();
      const parser = new DOMParser();
      const doc = parser.parseFromString(proxyData.contents, 'text/html');
      doc.querySelectorAll('script,style,nav,footer,header,aside').forEach(e => e.remove());
      pageText = (doc.body?.innerText || doc.body?.textContent || '').substring(0, 12000);
    } catch(e) {
      pageText = `Could not fetch page content. URL: ${url}`;
    }

    const sourceName = (() => { try { return new URL(url).hostname.replace('www.', ''); } catch(e) { return ''; } })();
    const recipe = await parseRecipeFromText(pageText, url, sourceName);
    if (!recipe) return;
    recipe.id = Date.now().toString();
    recipe.added_at = new Date().toISOString();

    recipes.unshift(recipe);
    await save(recipe);
    renderList();
    showRecipe(recipe.id);
    document.getElementById('url-input').value = '';
    setStatus(`Saved: ${recipe.title}`, 'success');
    setTimeout(clearStatus, 4000);

  } catch(e) {
    setStatus(`Error: ${e.message}`, 'error');
  } finally {
    document.getElementById('scrape-btn').disabled = false;
  }
}

function renderList() {
  const search = document.getElementById('search-input').value.toLowerCase();
  const maxTime = parseInt(document.getElementById('filter-time').value) || 0;
  const sortBy = document.getElementById('sort-by').value;

  let filtered = recipes.filter(r => {
    const matchText = !search ||
      r.title?.toLowerCase().includes(search) ||
      r.source_name?.toLowerCase().includes(search) ||
      r.tags?.some(t => t.toLowerCase().includes(search)) ||
      r.steps?.some(s => s.toLowerCase().includes(search)) ||
      r.ingredients?.some(i => (i.item || i).toLowerCase().includes(search)) ||
      r.ingredient_groups?.some(g => g.items?.some(i => i.item?.toLowerCase().includes(search)));
    const totalTime = (r.active_time_minutes || 0) + (r.passive_time_minutes || 0);
    const matchTime = !maxTime || totalTime <= maxTime || totalTime === 0;
    return matchText && matchTime;
  });

  if (sortBy === 'geography') {
    // Sort by first geography-related tag alphabetically
    const geoKeywords = ['italian','french','mexican','japanese','chinese','thai','indian','greek','spanish','american','korean','vietnamese','mediterranean','middle eastern','caribbean'];
    const getGeo = r => {
      const tag = (r.tags || []).find(t => geoKeywords.some(k => t.toLowerCase().includes(k)));
      return tag ? tag.toLowerCase() : 'zzz';
    };
    filtered.sort((a,b) => getGeo(a).localeCompare(getGeo(b)));
  } else if (sortBy === 'heat_spice') {
    // Sort by spice-related tags: mild -> medium -> hot -> extra hot, untagged last
    const spiceOrder = ['mild','medium','spicy','hot','extra hot','fiery'];
    const getSpice = r => {
      const tag = (r.tags || []).find(t => spiceOrder.some(k => t.toLowerCase().includes(k)));
      if (!tag) return 99;
      return spiceOrder.findIndex(k => tag.toLowerCase().includes(k));
    };
    filtered.sort((a,b) => getSpice(a) - getSpice(b));
  } else if (sortBy === 'heat_temp') {
    // Sort by cooking temperature tags: cold/raw -> room temp -> warm -> hot -> very hot
    const tempOrder = ['raw','no cook','cold','room temp','warm','low','medium','high','broil','very hot'];
    const getTemp = r => {
      const tag = (r.tags || []).find(t => tempOrder.some(k => t.toLowerCase().includes(k)));
      if (!tag) return 99;
      return tempOrder.findIndex(k => tag.toLowerCase().includes(k));
    };
    filtered.sort((a,b) => getTemp(a) - getTemp(b));
  }

  const list = document.getElementById('recipe-list');
  document.getElementById('recipe-count-label').textContent =
    `${recipes.length} recipe${recipes.length !== 1 ? 's' : ''} saved`;

  if (filtered.length === 0) {
    list.innerHTML = `<div class="empty-state"><p>${recipes.length === 0 ? 'Library empty' : 'No recipes match your search'}</p></div>`;
    return;
  }

  list.innerHTML = filtered.map(r => {
    const total = (r.active_time_minutes || 0) + (r.passive_time_minutes || 0);
    const timeStr = total ? `${total} min` : '';
    const servStr = r.servings ? `${r.servings} servings` : '';
    return `<div class="recipe-card ${activeId === r.id ? 'active' : ''}" onclick="showRecipe('${r.id}')">
      <div class="recipe-card-title">${r.title || 'Untitled'}</div>
      <div class="recipe-card-meta">
        ${timeStr ? `<span>${timeStr}</span>` : ''}
        ${servStr ? `<span>${servStr}</span>` : ''}
        
      </div>
    </div>`;
  }).join('');
}

function filterRecipes() { renderList(); }

function showRecipe(id) {
  const r = recipes.find(x => x.id === id);
  if (!r) return;
  activeId = id;
  renderList();

  document.getElementById('welcome-screen').style.display = 'none';
  const view = document.getElementById('recipe-view');
  view.style.display = 'block';

  const total = (r.active_time_minutes || 0) + (r.passive_time_minutes || 0);

  const metaItems = [
    r.active_time_minutes ? `<div class="rv-meta-item"><div class="label">Active</div><div class="value">${r.active_time_minutes}</div><div class="unit">min</div></div>` : '',
    r.passive_time_minutes ? `<div class="rv-meta-item"><div class="label">Passive</div><div class="value">${r.passive_time_minutes}</div><div class="unit">min</div></div>` : '',
    total ? `<div class="rv-meta-item"><div class="label">Total</div><div class="value">${total}</div><div class="unit">min</div></div>` : '',
    r.servings ? `<div class="rv-meta-item"><div class="label">Serves</div><div class="value">${r.servings}</div></div>` : '',
  ].filter(Boolean).join('');

  const tags = (r.tags || []).map(t => `<span class="tag">${t}</span>`).join('');

  // Support both new grouped format and legacy flat format
  let ingredientsHtml = '';
  if (r.ingredient_groups && r.ingredient_groups.length > 0) {
    ingredientsHtml = r.ingredient_groups.map(group => {
      const items = (group.items || []).map(ing => {
        const qty = ing.qty || '';
        const item = ing.item || '';
        return `<div class="ingredient-item" onclick="this.classList.toggle('checked')">
          ${qty ? `<span class="qty">${qty}</span>` : ''}<span>${item}</span>
        </div>`;
      }).join('');
      return `<div class="ingredient-group">
        <div class="ingredient-group-label">${group.section}</div>
        <div class="ingredients-grid">${items}</div>
      </div>`;
    }).join('');
  } else if (r.ingredients && r.ingredients.length > 0) {
    // legacy flat list
    const items = r.ingredients.map(ing => {
      const qty = ing.qty || '';
      const item = ing.item || ing;
      return `<div class="ingredient-item" onclick="this.classList.toggle('checked')">
        ${qty ? `<span class="qty">${qty}</span>` : ''}<span>${item}</span>
      </div>`;
    }).join('');
    ingredientsHtml = `<div class="ingredients-grid">${items}</div>`;
  }

  const steps = (r.steps || []).map((step, i) =>
    `<div class="step-item"><div class="step-num">${i+1}</div><div class="step-text">${step}</div></div>`
  ).join('');

  const commentTypeLabel = { worked: 'Process', didnt: 'Substitution', tip: 'Flavor' };
  const comments = (r.comment_highlights || []).map(c => {
    const type = c.type || 'tip';
    return `<div class="comment-item ${type}"><div class="comment-type">${commentTypeLabel[type] || 'Note'}</div>${c.text}</div>`;
  }).join('');

  const addedDate = r.added_at ? new Date(r.added_at).toLocaleDateString('en-US', {year:'numeric',month:'long',day:'numeric'}) : '';

  view.innerHTML = `
    <div class="rv-actions">
      <button class="btn btn-danger" onclick="deleteRecipe('${r.id}')">Delete</button>
      <button class="btn" onclick="editRecipe('${r.id}')">Edit</button>
      ${r.source_url ? `<a href="${r.source_url}" target="_blank" class="btn">View Original</a>` : ''}
    </div>

    <div class="rv-layout">
      <div class="rv-main">
        <div class="rv-title">${r.title || 'Untitled Recipe'}</div>
        <div class="rv-source">
          ${r.source_url ? `<a href="${r.source_url}" target="_blank">${r.source_name || r.source_url}</a>` : (r.source_name || '')}
          ${addedDate ? ` &mdash; Added ${addedDate}` : ''}
        </div>

        ${tags ? `<div class="rv-tags">${tags}</div>` : ''}
        ${metaItems ? `<div class="rv-meta">${metaItems}</div>` : ''}

        <div class="heat-sliders">
          <div class="heat-slider-block">
            <div class="heat-slider-title">Spice</div>
            <div class="heat-slider-wrap">
              <input type="range" class="heat-slider" id="slider-spice" min="0" max="4" step="1" value="${r.heat_spice !== undefined ? r.heat_spice : 2}" oninput="updateSliderTrack(this)" onchange="saveSlider('${r.id}','heat_spice',this.value)">
              <div class="heat-slider-labels">
                <span>none</span><span>mild</span><span>medium</span><span>hot</span><span>fire</span>
              </div>
            </div>
          </div>
          <div class="heat-slider-block">
            <div class="heat-slider-title">Temperature</div>
            <div class="heat-slider-wrap">
              <input type="range" class="heat-slider" id="slider-temp" min="0" max="4" step="1" value="${r.heat_temp !== undefined ? 4 - r.heat_temp : 2}" oninput="updateSliderTrack(this)" onchange="saveSlider('${r.id}','heat_temp', 4 - this.value)">
              <div class="heat-slider-labels">
                <span>cold</span><span>chilled</span><span>room</span><span>warm</span><span>hot!</span>
              </div>
            </div>
          </div>
        </div>

        ${ingredientsHtml ? `
          <div class="rv-section-title">Ingredients</div>
          <p style="font-size:11px;color:var(--dim);margin-top:-5px;margin-bottom:15px;"><em>click to check off</em></p>
          <div id="ingredients-container">${ingredientsHtml}</div>
          <hr class="rv-divider">
        ` : ''}

        ${steps ? `
          <div class="rv-section-title">Instructions</div>
          <div id="steps-list">${steps}</div>
        ` : ''}

        ${comments ? `
          <hr class="rv-divider">
          <div class="rv-section-title">Notes from Others</div>
          <div id="comments-list">${comments}</div>
        ` : ''}
      </div>

      <div>
        <div class="notes-panel">
          <div class="notes-panel-label">Notes to Self</div>
          <div class="notes-add-row">
            <textarea id="notes-new-text" placeholder="Add a note..."></textarea>
            <button class="notes-add-btn" onclick="addNote('${r.id}')">Add</button>
          </div>
          <div class="notes-log" id="notes-log">
            ${((r.notes_log || [])).map((n, i) => `
              <div class="note-entry">
                <div class="note-entry-date">${n.date}</div>
                <div class="note-entry-text">${n.text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
                <button class="note-entry-delete" onclick="deleteNote(event,'${r.id}',${i})">remove</button>
              </div>
            `).join('')}
          </div>
          <div class="notes-saved" id="notes-status"></div>
        </div>

        <div class="photos-panel">
          <div class="photos-panel-label">Photos</div>
          <div class="photo-slots" id="photo-slots">
            ${[0,1,2].map(i => {
              const img = (r.photos || [])[i];
              return img
                ? `<div class="photo-slot" onclick="triggerPhotoUpload('${r.id}',${i})">
                    <img src="${img}" alt="Photo ${i+1}">
                    <button class="photo-remove" onclick="removePhoto(event,'${r.id}',${i})">Remove</button>
                   </div>`
                : `<div class="photo-slot" onclick="triggerPhotoUpload('${r.id}',${i})">
                    <div class="photo-slot-empty">
                      <span class="photo-slot-empty-icon">+</span>
                      <span>Add photo</span>
                    </div>
                   </div>`;
            }).join('')}
          </div>
          <input type="file" id="photo-input" accept="image/*" style="display:none" onchange="handlePhotoUpload(event)">
        </div>
      </div>
    </div>
  `;
  initSliderTracks();
}

function editRecipe(id) {
  const r = recipes.find(x => x.id === id);
  if (!r) return;

  const view = document.getElementById('recipe-view');

  // Flatten ingredient_groups to text (one per line, section headers prefixed with #)
  let ingText = '';
  if (r.ingredient_groups && r.ingredient_groups.length > 0) {
    ingText = r.ingredient_groups.map(g =>
      '# ' + g.section + '\n' + (g.items || []).map(i => (i.qty ? i.qty + ' ' : '') + i.item).join('\n')
    ).join('\n\n');
  } else if (r.ingredients && r.ingredients.length > 0) {
    ingText = r.ingredients.map(i => (i.qty ? i.qty + ' ' : '') + (i.item || i)).join('\n');
  }

  const stepsText = (r.steps || []).join('\n');

  const commentTypeLabel = { worked: 'PROCESS', didnt: 'SUBSTITUTION', tip: 'FLAVOR' };
  const commentsText = (r.comment_highlights || []).map(c =>
    (commentTypeLabel[c.type] || 'TIP') + ': ' + c.text
  ).join('\n');

  const tagsText = (r.tags || []).join(', ');
  const addedDate = r.added_at ? new Date(r.added_at).toLocaleDateString('en-US', {year:'numeric',month:'long',day:'numeric'}) : '';

  view.innerHTML = `
    <div class="rv-actions">
      <button class="btn btn-primary" onclick="saveEdit('${r.id}')">Save</button>
      <button class="btn" onclick="showRecipe('${r.id}')">Cancel</button>
    </div>

    <input class="edit-title" id="e-title" value="${(r.title || '').replace(/"/g, '&quot;')}">

    <div class="edit-meta-row">
      <div class="edit-meta-item">
        <div class="field-label">Active time (min)</div>
        <input id="e-active" type="number" value="${r.active_time_minutes || ''}">
      </div>
      <div class="edit-meta-item">
        <div class="field-label">Passive time (min)</div>
        <input id="e-passive" type="number" value="${r.passive_time_minutes || ''}">
      </div>
      <div class="edit-meta-item">
        <div class="field-label">Servings</div>
        <input id="e-servings" type="number" value="${r.servings || ''}">
      </div>
    </div>

    <div class="edit-section">
      <div class="field-label">Tags (comma-separated)</div>
      <input class="edit-field" id="e-tags" value="${tagsText.replace(/"/g, '&quot;')}">
    </div>

    <div class="edit-section">
      <div class="field-label">Ingredients</div>
      <div class="edit-hint">Use # Section Name to create groups. One ingredient per line.</div>
      <textarea class="edit-field" id="e-ingredients" rows="12">${ingText}</textarea>
    </div>

    <div class="edit-section">
      <div class="field-label">Instructions (one step per line)</div>
      <textarea class="edit-field" id="e-steps" rows="10">${stepsText}</textarea>
    </div>

    <div class="edit-section">
      <div class="field-label">Notes from Others (prefix: PROCESS: / FLAVOR: / SUBSTITUTION:)</div>
      <textarea class="edit-field" id="e-comments" rows="5">${commentsText}</textarea>
    </div>

    ${r.source_url ? `<div style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:0.4px;margin-top:8px;">Source: <a href="${r.source_url}" target="_blank" style="color:var(--link)">${r.source_name || r.source_url}</a>${addedDate ? ' &mdash; Added ' + addedDate : ''}</div>` : ''}

  `;
}

function saveEdit(id) {
  const idx = recipes.findIndex(x => x.id === id);
  if (idx === -1) return;

  const r = { ...recipes[idx] };

  r.title = document.getElementById('e-title').value.trim();
  r.active_time_minutes = parseInt(document.getElementById('e-active').value) || 0;
  r.passive_time_minutes = parseInt(document.getElementById('e-passive').value) || 0;
  r.servings = parseInt(document.getElementById('e-servings').value) || 0;
  r.tags = document.getElementById('e-tags').value.split(',').map(t => t.trim()).filter(Boolean);
  r.steps = document.getElementById('e-steps').value.split('\n').map(s => s.trim()).filter(Boolean);

  // Parse comments
  const commentLines = document.getElementById('e-comments').value.split('\n').filter(l => l.trim());
  r.comment_highlights = commentLines.map(l => {
    if (l.toUpperCase().startsWith('PROCESS:')) return { type: 'worked', text: l.slice(8).trim() };
    if (l.toUpperCase().startsWith('SUBSTITUTION:')) return { type: 'didnt', text: l.slice(13).trim() };
    return { type: 'tip', text: l.replace(/^FLAVOR:/i, '').trim() };
  });

  // Parse ingredients - support # Section headers
  const ingLines = document.getElementById('e-ingredients').value.split('\n');
  const groups = [];
  let currentSection = null;

  for (const raw of ingLines) {
    const line = raw.trim();
    if (!line) continue;
    if (line.startsWith('#')) {
      currentSection = { section: line.replace(/^#+\s*/, ''), items: [] };
      groups.push(currentSection);
    } else {
      const match = line.match(/^([0-9\u00bc\u00bd\u00be\u2153\u2154\u215b\s\/\.]+\s*(?:cup|tbsp|tsp|oz|lb|g|kg|ml|l|pinch|clove|slice|piece|can|bunch|head|stalk|sprig|handful|package|pkg|small|medium|large|inch|cm)?s?\.?)\s+(.+)/i);
      const item = match ? { qty: match[1].trim(), item: match[2].trim() } : { qty: '', item: line };
      if (currentSection) {
        currentSection.items.push(item);
      } else {
        // No section header yet - put in a default group
        if (groups.length === 0) groups.push({ section: 'Ingredients', items: [] });
        groups[0].items.push(item);
      }
    }
  }

  if (groups.length > 0) {
    r.ingredient_groups = groups;
    delete r.ingredients;
  }

  recipes[idx] = r;
  save(r);
  renderList();
  showRecipe(id);
}

function addNote(id) {
  const field = document.getElementById('notes-new-text');
  if (!field) return;
  const text = field.value.trim();
  if (!text) return;
  const idx = recipes.findIndex(x => x.id === id);
  if (idx === -1) return;
  if (!recipes[idx].notes_log) recipes[idx].notes_log = [];
  const date = new Date().toLocaleDateString('en-US', {year:'numeric', month:'long', day:'numeric'});
  recipes[idx].notes_log.unshift({ date, text });
  save(recipes[idx]);
  field.value = '';
  // Re-render log
  const log = document.getElementById('notes-log');
  if (log) {
    log.innerHTML = recipes[idx].notes_log.map((n, i) => `
      <div class="note-entry">
        <div class="note-entry-date">${n.date}</div>
        <div class="note-entry-text">${n.text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
        <button class="note-entry-delete" onclick="deleteNote(event,'${id}',${i})">remove</button>
      </div>
    `).join('');
  }
  const el = document.getElementById('notes-status');
  if (el) {
    el.textContent = 'Saved';
    setTimeout(() => { if (el) el.textContent = ''; }, 2000);
  }
}

function deleteNote(event, id, index) {
  event.stopPropagation();
  if (!confirm('Are you sure you want to scrape the board?')) return;
  const idx = recipes.findIndex(x => x.id === id);
  if (idx === -1) return;
  recipes[idx].notes_log.splice(index, 1);
  save(recipes[idx]);
  // Re-render log
  const log = document.getElementById('notes-log');
  if (log) {
    log.innerHTML = recipes[idx].notes_log.map((n, i) => `
      <div class="note-entry">
        <div class="note-entry-date">${n.date}</div>
        <div class="note-entry-text">${n.text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
        <button class="note-entry-delete" onclick="deleteNote(event,'${id}',${i})">remove</button>
      </div>
    `).join('');
  }
}

let _photoUploadTarget = { id: null, slot: null };

function triggerPhotoUpload(id, slot) {
  _photoUploadTarget = { id, slot };
  document.getElementById('photo-input').value = '';
  document.getElementById('photo-input').click();
}

function handlePhotoUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  const { id, slot } = _photoUploadTarget;
  const reader = new FileReader();
  reader.onload = function(e) {
    const idx = recipes.findIndex(x => x.id === id);
    if (idx === -1) return;
    if (!recipes[idx].photos) recipes[idx].photos = [null, null, null];
    recipes[idx].photos[slot] = e.target.result;
    save(recipes[idx]);
    showRecipe(id);
  };
  reader.readAsDataURL(file);
}

function removePhoto(event, id, slot) {
  event.stopPropagation();
  const idx = recipes.findIndex(x => x.id === id);
  if (idx === -1) return;
  if (!recipes[idx].photos) return;
  recipes[idx].photos[slot] = null;
  save(recipes[idx]);
  showRecipe(id);
}

async function updateSliderTrack(el) {
  const pct = (el.value / el.max) * 100;
  el.style.background = `linear-gradient(to right, var(--black) ${pct}%, var(--light) ${pct}%)`;
}

function saveSlider(id, field, value) {
  const idx = recipes.findIndex(x => x.id === id);
  if (idx === -1) return;
  recipes[idx][field] = parseInt(value);
  save(recipes[idx]);
}

// Init all slider tracks on page
function initSliderTracks() {
  document.querySelectorAll('.heat-slider').forEach(el => updateSliderTrack(el));
}

async function deleteRecipe(id) {
  if (!confirm('Remove this recipe from your library?')) return;
  recipes = recipes.filter(r => r.id !== id);
  await deleteFromDb(id);
  activeId = null;
  document.getElementById('recipe-view').style.display = 'none';
  document.getElementById('welcome-screen').style.display = 'flex';
  renderList();
}

function openManualEntry() {
  document.getElementById('modal-overlay').style.display = 'flex';
}

function closeModal() {
  document.getElementById('modal-overlay').style.display = 'none';
}

function saveManualRecipe() {
  const title = document.getElementById('m-title').value.trim();
  if (!title) { alert('Please enter a title.'); return; }

  const ingLines = document.getElementById('m-ingredients').value.split('\n').filter(l => l.trim());
  const ingredients = ingLines.map(line => {
    const match = line.match(/^([0-9\u00bc\u00bd\u00be\u2153\u2154\u215b\s\/\.]+\s*(?:cup|tbsp|tsp|oz|lb|g|kg|ml|l|pinch|clove|slice|piece|can|bunch|head|stalk|sprig|handful|package|pkg|small|medium|large|inch|cm)?s?\.?)\s+(.+)/i);
    if (match) return { qty: match[1].trim(), item: match[2].trim() };
    return { qty: '', item: line.trim() };
  });

  const steps = document.getElementById('m-steps').value.split('\n').filter(l => l.trim());
  const commentLines = document.getElementById('m-comments').value.split('\n').filter(l => l.trim());
  const comments = commentLines.map(l => {
    if (l.toUpperCase().startsWith('PROCESS:')) return { type: 'worked', text: l.slice(8).trim() };
    if (l.toUpperCase().startsWith('SUBSTITUTION:')) return { type: 'didnt', text: l.slice(13).trim() };
    return { type: 'tip', text: l.replace(/^FLAVOR:/i, '').trim() };
  });

  const tags = document.getElementById('m-tags').value.split(',').map(t => t.trim()).filter(Boolean);

  const recipe = {
    id: Date.now().toString(),
    added_at: new Date().toISOString(),
    title,
    source_url: document.getElementById('m-source').value.trim(),
    source_name: '',
    active_time_minutes: parseInt(document.getElementById('m-active').value) || 0,
    passive_time_minutes: parseInt(document.getElementById('m-passive').value) || 0,
    servings: parseInt(document.getElementById('m-servings').value) || 0,
    tags,
    ingredients,
    steps,
    comment_highlights: comments
  };

  recipes.unshift(recipe);
  save(recipe);
  renderList();
  showRecipe(recipe.id);
  closeModal();

  ['m-title','m-source','m-active','m-passive','m-servings','m-tags','m-ingredients','m-steps','m-comments'].forEach(id => {
    document.getElementById(id).value = '';
  });
}

document.getElementById('modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
</script>
</body>
</html>
